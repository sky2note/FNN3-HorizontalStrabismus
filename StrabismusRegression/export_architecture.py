#!/usr/bin/env python
# export_architecture.py

import sys
from pathlib import Path

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. å°†é¡¹ç›®æ ¹ç›®å½•åŠ å…¥ Python æ¨¡å—æœç´¢è·¯å¾„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ROOT = Path(__file__).parent.resolve()
sys.path.insert(0, str(ROOT))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. å¯¼å…¥ä¾èµ–
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
from torchinfo import summary
from src.config import C
from src.models.classification_model import SurgeryIndicatorModel
from src.models.regression_model     import RegressionModel

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. å¯¼å‡ºå‡½æ•°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def dump_model(model, input_size, outfile):
    """
    å¯¼å‡º model çš„å±‚çº§ç»“æ„ï¼š
      - input_size: tuple, summary() çš„ input_size
      - outfile:    Path æˆ– str, è¾“å‡ºæ–‡æœ¬æ–‡ä»¶è·¯å¾„
    æ–‡æœ¬æœ«å°¾è‡ªåŠ¨è¿½åŠ  ReLU æ¿€æ´»ä¸ Xavier Uniform åˆå§‹åŒ–è¯´æ˜ã€‚
    """
    s = summary(
        model,
        input_size=input_size,
        col_names=("input_size","output_size","num_params"),
        verbose=0
    )
    txt = s.__str__()
    txt += "\nActivation   : ReLU\n"
    txt += "Weight Init  : Xavier Uniform\n"
    Path(outfile).write_text(txt, encoding="utf-8")
    print(f"âœ… å†™å…¥ï¼š{outfile}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. ä¸»æµç¨‹
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    # ç¡®ä¿ results ç›®å½•å­˜åœ¨
    results_dir = ROOT / "results"
    results_dir.mkdir(exist_ok=True)

    # â€”â€” 4.1 å¯¼å‡ºåˆ†ç±»æ¨¡å‹ â€”â€”
    # æ ¹æ® src/models/classification_model.py çš„ __init__ ç­¾åæ¥ä¼ å‚
    cls_model = SurgeryIndicatorModel(
        input_dim   = getattr(C, "INPUT_DIM",  C.INPUT_DIM),
        hidden_dims = getattr(C, "HIDDEN_SIZES", (64,128,64)),
        dropout     = getattr(C, "DROPOUT",      0.3),
        n_residual  = getattr(C, "N_RESIDUAL",    2),
        output_dim  = getattr(C, "OUTPUT_DIM",    8),
        use_cc      = getattr(C, "USE_CC",       False),
    )
    dump_model(
        model      = cls_model,
        input_size = (1, C.INPUT_DIM),
        outfile    = results_dir / "model_arch_classifier.txt"
    )

    # â€”â€” 4.2 å¯¼å‡ºå›å½’æ¨¡å‹ â€”â€”
    # RegressionModel æ„é€ æ— éœ€å¤–éƒ¨å‚æ•°
    reg_model = RegressionModel()
    dump_model(
        model      = reg_model,
        input_size = (1, C.INPUT_DIM),
        outfile    = results_dir / "model_arch_regressor.txt"
    )

    print("ğŸ‰ åˆ†ç±»ä¸å›å½’æ¨¡å‹ç»“æ„å‡å·²å¯¼å‡ºè‡³ results/ ç›®å½•ä¸‹ã€‚")
